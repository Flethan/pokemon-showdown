<!DOCTYPE html>
<html>

<body>
  <script>
    const crcTable = [];
    let c;
    for (let n = 0; n < 256; n++) {
      c = n;
      for (let k = 0; k < 8; k++) {
        c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
      }
      crcTable[n] = c;
    }

    function crc32(buf) {
      let crc = 0xFFFFFFFF;

      for (let i = 0; i < buf.length; i++) {
        crc = crcTable[(crc ^ buf[i]) & 0xFF] ^ (crc >>> 8);
      }

      return (crc ^ 0xFFFFFFFF) >>> 0;
    };

    function B64ToIA(string) {
      return Uint8Array.from(atob(string), c => c.charCodeAt(0));
    };

    function IAToB64(intArray) {
      return btoa(intArray.reduce((data, byte) => data + String.fromCharCode(byte), ''));
    };

    function parseColor(string) {
      if (!/^#?([0-9a-fA-F]{2}){3,4}$/.test(string)) return false;
      string = string.replace("#", "");
      return [
        parseInt(string.substr(0, 2), 16),
        parseInt(string.substr(2, 2), 16),
        parseInt(string.substr(4, 2), 16),
      ];
    };

    function RGBToHSL(r, g, b) {
      r /= 255;
      g /= 255;
      b /= 255;

      let cmin = Math.min(r, g, b),
        cmax = Math.max(r, g, b),
        delta = cmax - cmin,
        h = 0,
        s = 0,
        l = 0;

      if (delta == 0) h = 0;
      else if (cmax == r) h = ((g - b) / delta) % 6;
      else if (cmax == g) h = (b - r) / delta + 2;
      else h = (r - g) / delta + 4;

      h = Math.round(h * 60);
      if (h < 0) h += 360;

      l = (cmax + cmin) / 2;

      s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));

      return [h, s, l];
    };

    function HSLtoRGB(h, s, l) {
      let c = (1 - Math.abs(2 * l - 1)) * s,
        x = c * (1 - Math.abs((h / 60) % 2 - 1)),
        m = l - c / 2,
        r = 0,
        g = 0,
        b = 0;

      if (0 <= h && h < 60) {
        r = c; g = x; b = 0;
      } else if (60 <= h && h < 120) {
        r = x; g = c; b = 0;
      } else if (120 <= h && h < 180) {
        r = 0; g = c; b = x;
      } else if (180 <= h && h < 240) {
        r = 0; g = x; b = c;
      } else if (240 <= h && h < 300) {
        r = x; g = 0; b = c;
      } else if (300 <= h && h < 360) {
        r = c; g = 0; b = x;
      }
      r = Math.round((r + m) * 255);
      g = Math.round((g + m) * 255);
      b = Math.round((b + m) * 255);

      return [r, g, b];

    }

    function HSLdelta(hsl1, hsl2) {
      const dh = (hsl2[0] - hsl1[0]) % 360;

      let ds = 0;
      if (hsl2[1] > hsl1[1]) {
        ds = (hsl2[1] - hsl1[1]) / (1 - hsl1[1]) || 0;
      } else {
        ds = -(hsl1[1] - hsl2[1]) / hsl1[1] || 0;
      }

      let dl = 0;
      if (hsl2[2] > hsl1[2]) {
        dl = (hsl2[2] - hsl1[2]) / (1 - hsl1[2]) || 0;
      } else {
        dl = -(hsl1[2] - hsl2[2]) / hsl1[2] || 0;
      }

      return [dh, ds, dl];
    };

    function applyDelta(hsl, delta) {
      const dh = (hsl[0] + delta[0]) % 360;

      let ds = hsl[1];
      if (delta[1] > 0) {
        ds = hsl[1] + ((1 - hsl[1]) * delta[1]);
      } else {
        ds = hsl[1] + (hsl[1] * delta[1]);
      }

      let dl = hsl[2];
      if (delta[2] > 0) {
        dl = hsl[2] + ((1 - hsl[2]) * delta[2]);
      } else {
        dl = hsl[2] + (hsl[2] * delta[2]);
      }

      return [dh, ds, dl];
    };

    function constructReplaceObj(calibration, palette) {
      const replaceObj = {};
      for (let [index, group] of calibration.entries()) {
        if (!(index < palette.length)) break;

        let color = parseColor(palette[index]);
        if (!color) break;
        color = RGBToHSL(...color);

        let groupLead = parseColor(group[0]);
        if (!groupLead) continue;
        groupLead = RGBToHSL(...groupLead);

        const delta = HSLdelta(groupLead, color);

        for (let unit of group) {
          const unitColor = parseColor(unit);
          if (!unitColor) continue;
          const unitNew = HSLtoRGB(...applyDelta(RGBToHSL(...unitColor), delta));

          replaceObj[unitColor.reduce((a, b) => b + (a << 8))] = unitNew;
        }
      }
      return replaceObj;
    }

    function replaceB64(imgB64, replaceObj) {
      const imgIA = B64ToIA(imgB64);
      let plteIndex = 0;
      let plteLength = 0;
      for (let i = 0; i < imgIA.length; i++) {
        if (imgIA[i] === 0x50 && imgIA[i + 1] === 0x4C && imgIA[i + 2] === 0x54 && imgIA[i + 3] === 0x45) {
          plteIndex = i;
          plteLength = (
            (imgIA[i - 4] << 24) +
            (imgIA[i - 3] << 16) +
            (imgIA[i - 2] << 8) +
            imgIA[i - 1]
          );
        }
      }

      for (let i = 0; i < ((plteLength) / 3); i++) {
        const slice = imgIA.slice(plteIndex + 4 + (i * 3), plteIndex + 4 + (i * 3) + 3)
          .reduce((a, b) => b + (a << 8));
        const replace = replaceObj[slice];
        if (!replace) continue;

        imgIA[plteIndex + 4 + (i * 3)] = replace[0];
        imgIA[plteIndex + 4 + (i * 3) + 1] = replace[1];
        imgIA[plteIndex + 4 + (i * 3) + 2] = replace[2];
      }

      const newCrc = crc32(imgIA.slice(plteIndex, plteIndex + plteLength + 4));
      imgIA[plteIndex + 4 + plteLength] = (newCrc & 0xFF000000) >> 24;
      imgIA[plteIndex + 4 + plteLength + 1] = (newCrc & 0x00FF0000) >> 16;
      imgIA[plteIndex + 4 + plteLength + 2] = (newCrc & 0x0000FF00) >> 8;
      imgIA[plteIndex + 4 + plteLength + 3] = newCrc & 0x000000FF;

      return IAToB64(imgIA);
    }

    function changeHelperSquares(calibration, replaceObj) {
      for (let [indexG, group] of calibration.entries()) {
        for (let [indexU, unit] of group.entries()) {
          if (replaceObj) {
            unit = unit.replace("#", "");
            let color = replaceObj[parseInt(unit, 16)].reduce((a, b) => b + (a << 8)).toString(16);
            document.querySelector(`#g${indexG + 1}u${indexU + 1}`).style = `background-color: #${color};`;
          }
          else document.querySelector(`#g${indexG + 1}u${indexU + 1}`).style = `background-color: ${unit};`;
        }
      }
    }

    const imgB64 = "iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAMAAADVRocKAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADr8AAA6/ATgFUyQAAABLUExURQAAAABAfwB/AACA/wD/ABkZGTAwMEBAQEdHR1V6AFubPmBgYH8AAH8A/39uAICAgJ8A36CgoK+vr78Av98An+G4aP8AAP8Af//gALL5Dd0AAAABdFJOUwBA5thmAAACTklEQVRo3u2X63KDIBBGQU2Nl0i1wfj+T1qWiyxCZirCj3TYGdKmkzln/TCLJaRUqVKlSpUqla/a3PCWZYZnESB4y1g2OAO4WCwXfF854fAjlSAIlwKWSBCCt6wT5XxwlhXDD8P7vj8IHt8/z2iBB4fq3IxAcDEhBO97zlMI3sI5P2YE/FekwIdzlVEKQajz3gjYRf67zu+iDgLJPy8IdA7wRdQdZ/SI4yvBoXPBvsFCAoGP45Mu0Dngb/ByVxk9JD6Ov2e0wz0B0BU+iq8ECn7T0ei16G0GemT3VmDhN8lezF0kBPHNY4HKZEFwrre/e76uDWv3EmznXK/u6plgLsHtXC3uTYvo28iNhQ8cXUISgeU5b+Iz2rYNGXa4fbGGKMFUNdU0TYSs69o5cJ3P0F/KaF1HSqtK0Ou67gKdD6Kk5OwuwzOBwFJKxlHSm6bZBfJVUwflkH89kdE8y6ZpBVch6WIvNmTgO9W4xCg8swnzDNgKwq8lHX7t8P2jDdycEiczmmeBhc0VgmojI20mNbL3U00ZOMKLaXFqE/TtuVKBHutmQ6eaooKBI3x/MiP97EdXGdMWODcHOyZ0ROzkfQRV0dXw0bmJvsn4mx0zLaamNnx0bmITvyYgW2P4JPBU5A6nuHlnp5GfEUfz2nuKj5mox4zMJQD8K8G/IMGMTOfpBB5coVMInIxs5ikFHjyDQMIdWkqB6dylJTSEYZ8lCNGyC9S7jxGEaGUT/pjRhwn8TUjGf3cJeQXkKyE/ceJvDFn5+QVpEy9VqlSp/1W/9IpK9F2IYRgAAAAASUVORK5CYII=";
    const calibration = [
        ["#557A00", "#5B9B3E"],
        ["#E1B868"],
        ["#7F00FF", "#9F00DF", "#BF00BF", "#DF009F", "#FF007F"],
        ["#FF0000", "#0080FF", "#00FF00", "#FFE000", "#7F0000", "#00407F", "#007F00", "#7F6E00"],
        ["#191919", "#303030", "#474747", "#606060", "#A0A0A0", "#AFAFAF"]
    ];

    let colorWell1;
    let colorWell2;
    let colorWell3;
    let colorWell4;
    let colorWell5;

    window.addEventListener("load", startup, false);

    function startup() {
      changeHelperSquares(calibration, null);
      colorWell1 = document.querySelector("#colorWell1");
      colorWell2 = document.querySelector("#colorWell2");
      colorWell3 = document.querySelector("#colorWell3");
      colorWell4 = document.querySelector("#colorWell4");
      colorWell5 = document.querySelector("#colorWell5");
      colorWell1.value = calibration[0][0];
      colorWell2.value = calibration[1][0];
      colorWell3.value = calibration[2][0];
      colorWell4.value = calibration[3][0];
      colorWell5.value = calibration[4][0];
      colorWell1.addEventListener("input", changePalette, false);
      colorWell2.addEventListener("input", changePalette, false);
      colorWell3.addEventListener("input", changePalette, false);
      colorWell4.addEventListener("input", changePalette, false);
      colorWell5.addEventListener("input", changePalette, false);
    }

    function changePalette(event) {
      const palette = [colorWell1.value, colorWell2.value, colorWell3.value, colorWell4.value, colorWell5.value];
      const replaceObj = constructReplaceObj(calibration, palette);
      changeHelperSquares(calibration, replaceObj);
      const newB64 = replaceB64(imgB64, replaceObj);
      thing.src = `data:image/png;base64, ${newB64}`;
    }

    function resetPalette() {
      changeHelperSquares(calibration, null);
      colorWell1.value = calibration[0][0];
      colorWell2.value = calibration[1][0];
      colorWell3.value = calibration[2][0];
      colorWell4.value = calibration[3][0];
      colorWell5.value = calibration[4][0];
      thing.src = `data:image/png;base64, ${imgB64}`;
    }
  </script>

  <div class="row">
    <div class="column">
      <p style="text-align: right;">Thing swapper.</p>
    </div>
    <div class="column-center">
      <img id="thing" src="undulux.png">
    </div>
    <div class="column">
      <label for="colorWell1">Group 1:</label>
      <input type="color" value="#FFFFFF" id="colorWell1">
      <div class="color-box" id="g1u1"></div>
      <div class="color-box" id="g1u2"></div>
      <div class="color-box" id="g1u3"></div>
      <div class="color-box" id="g1u4"></div>
      <div class="color-box" id="g1u5"></div>
      <div class="color-box" id="g1u6"></div>
      <div class="color-box" id="g1u7"></div>
      <div class="color-box" id="g1u8"></div>
      <br />
      <br />
      <label for="colorWell2">Group 2:</label>
      <input type="color" value="#FFFFFF" id="colorWell2">
      <div class="color-box" id="g2u1"></div>
      <div class="color-box" id="g2u2"></div>
      <div class="color-box" id="g2u3"></div>
      <div class="color-box" id="g2u4"></div>
      <div class="color-box" id="g2u5"></div>
      <div class="color-box" id="g2u6"></div>
      <div class="color-box" id="g2u7"></div>
      <div class="color-box" id="g2u8"></div>
      <br />
      <br />
      <label for="colorWell3">Group 3:</label>
      <input type="color" value="#FFFFFF" id="colorWell3">
      <div class="color-box" id="g3u1"></div>
      <div class="color-box" id="g3u2"></div>
      <div class="color-box" id="g3u3"></div>
      <div class="color-box" id="g3u4"></div>
      <div class="color-box" id="g3u5"></div>
      <div class="color-box" id="g3u6"></div>
      <div class="color-box" id="g3u7"></div>
      <div class="color-box" id="g3u8"></div>
      <br />
      <br />
      <label for="colorWell4">Group 4:</label>
      <input type="color" value="#FFFFFF" id="colorWell4">
      <div class="color-box" id="g4u1"></div>
      <div class="color-box" id="g4u2"></div>
      <div class="color-box" id="g4u3"></div>
      <div class="color-box" id="g4u4"></div>
      <div class="color-box" id="g4u5"></div>
      <div class="color-box" id="g4u6"></div>
      <div class="color-box" id="g4u7"></div>
      <div class="color-box" id="g4u8"></div>
      <br />
      <br />
      <label for="colorWell5">Group 5:</label>
      <input type="color" value="#FFFFFF" id="colorWell5">
      <div class="color-box" id="g5u1"></div>
      <div class="color-box" id="g5u2"></div>
      <div class="color-box" id="g5u3"></div>
      <div class="color-box" id="g5u4"></div>
      <div class="color-box" id="g5u5"></div>
      <div class="color-box" id="g5u6"></div>
      <div class="color-box" id="g5u7"></div>
      <div class="color-box" id="g5u8"></div>
      <br />
      <br />
      <button onclick="resetPalette()">Reset</button>
    </div>
  </div>

  <style>
    .column {
      float: left;
      width: 30%;
    }

    .column-center {
      float: left;
      width: 20%;
    }

    .row:after {
      content: "";
      display: table;
      clear: both;
    }

    img {
      display: block;
      width: 192px;
      image-rendering: pixelated;
      margin-left: auto;
      margin-right: auto;
    }

    .color-box {
      width: 15px;
      height: 15px;
      display: inline-block;
      margin-left: 10px;
    }
  </style>
</body>

</html>